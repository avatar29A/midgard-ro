# Session Log: 2026-01-10

## Summary
Implemented complete GUI Testing Infrastructure (ADR-010) for the GRF Browser tool, enabling Claude to see, understand, and control the ImGui-based GUI during debugging sessions.

## Completed Tasks

### 1. ADR-010: GUI Testing Infrastructure (PR #18, #19, #20)

Designed and implemented a three-phase approach to solve the problem of debugging ImGui GUIs with AI assistance:

#### Phase 1: Screenshot Capture (PR #18)
- **F12 hotkey** triggers screenshot capture
- Screenshots saved to `/tmp/grfbrowser/` with timestamps
- `latest.png` symlink for easy automation access
- Cross-platform HiDPI/Retina support using `DisplaySize * DisplayFramebufferScale`
- Deferred capture (next frame) to ensure ImGui content is rendered
- Read from `GL_FRONT` buffer after swap

#### Phase 2: JSON State Dump (PR #19)
- **Ctrl+D hotkey** exports GUI state as JSON
- State includes: selectedPath, searchText, expandedPaths, filters, stats
- Saved to `/tmp/grfbrowser/state.json`
- Machine-readable alternative to visual inspection

#### Phase 3: Command Interface (PR #20)
- File-based command system via `/tmp/grfbrowser/command.json`
- Single-shot execution (file deleted after processing)
- Polling each frame in render loop
- Supported commands:
  - `select_file` - Select a file by path
  - `expand_folder` / `collapse_folder` - Control tree expansion
  - `set_search` / `clear_search` - Control search filter
  - `set_filter` - Enable/disable file type filters
  - `screenshot` / `dump_state` - Trigger captures

## Files Created/Modified

### New Files
- `docs/adr/ADR-010-gui-testing-infrastructure.md` - Design document

### Modified Files
- `cmd/grfbrowser/main.go` - Added ~300 lines for testing infrastructure:
  - `captureScreenshot()` - OpenGL framebuffer capture
  - `GUIState` struct and `dumpState()` - JSON export
  - `Command` struct and `executeCommand()` - Command processing
  - `checkAndExecuteCommand()` - File polling

## Pull Requests

| PR | Title | Status |
|----|-------|--------|
| #18 | feat(grfbrowser): add screenshot capture with F12 (ADR-010 Phase 1) | Merged |
| #19 | feat(grfbrowser): add GUI state dump with Ctrl+D (ADR-010 Phase 2) | Merged |
| #20 | feat(grfbrowser): add command interface for GUI automation (ADR-010 Phase 3) | Merged |

## Technical Notes

### Screenshot Capture Challenges
1. **OpenGL initialization**: Must call `gl.Init()` after window creation
2. **Buffer selection**: Read from `GL_FRONT` (displayed content) not `GL_BACK`
3. **HiDPI scaling**: Use `io.DisplaySize() * io.DisplayFramebufferScale()` for actual pixels
4. **Timing**: Deferred capture (request on F12, capture next frame) ensures content is rendered

### Command Interface Design
- Polling-based (check file each frame) vs file watcher for simplicity
- Single-shot pattern prevents re-execution
- Reuses notification system from screenshot feature

## Usage Examples

```bash
# Claude can now:

# 1. See the GUI
echo '{"action": "screenshot"}' > /tmp/grfbrowser/command.json
# Then read /tmp/grfbrowser/latest.png

# 2. Understand the state
echo '{"action": "dump_state"}' > /tmp/grfbrowser/command.json
# Then read /tmp/grfbrowser/state.json

# 3. Control the GUI
echo '{"action": "set_search", "value": "monster"}' > /tmp/grfbrowser/command.json
echo '{"action": "expand_folder", "path": "data/sprite"}' > /tmp/grfbrowser/command.json
```

## Next Session

Potential improvements:
1. Auto-dump state after command execution
2. Batch command support (array of commands)
3. Response file with command result/error
4. Use case documentation for QA testing with new infrastructure

## Key Insight

The core problem was that debugging ImGui GUIs with AI required describing visual state in text. The solution provides three complementary approaches:
- **Visual** (screenshot) - for layout/appearance issues
- **Structural** (JSON state) - for precise state verification
- **Interactive** (commands) - for reproducing user actions

This creates a complete feedback loop for AI-assisted GUI debugging.
