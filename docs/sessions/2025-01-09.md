# Session: January 9, 2025 - Project Recovery & Milestone 1

## Context
- Previous session: Lost due to conversation failure
- Current milestone: Milestone 1 (Window & Triangle)
- Branch: main

## Goals Today
1. ✅ Review project state after conversation loss
2. ✅ Create workflow documentation for Claude Code sessions
3. ✅ Research Korangar and community resources
4. ✅ Update PRD with external references
5. ✅ Implement Milestone 1: Window & Triangle

## What Was Done

### Phase 1: Project Recovery
- Reviewed existing project structure
- Created `docs/WORKFLOW.md` - comprehensive workflow guide
- Created `docs/sessions/` directory for session logs
- Updated `CLAUDE.md` with session continuity instructions

### Phase 2: Research
- Discovered Korangar (Rust/Vulkan RO client)
- Found Ragnarok Research Lab (authoritative file format docs)
- Created `docs/research/korangar-and-community.md`
- Updated PRD Section 11 with external references

### Phase 3: Milestone 1 Implementation (initial attempt with SDL3)
Created/updated the following files:

**New Files:**
- `internal/engine/window/window.go` - SDL window + OpenGL context
- Updated `internal/engine/input/input.go` - SDL event handling
- Updated `internal/engine/renderer/renderer.go` - OpenGL rendering + shaders

### Phase 4: SDL3 → SDL2 Migration
The go-sdl3 bindings had version resolution issues. Migrated to SDL2:

**Changes:**
- Updated `go.mod` to use `github.com/veandco/go-sdl2 v0.4.40`
- Rewrote `internal/engine/window/window.go` for SDL2 API
- Rewrote `internal/engine/input/input.go` for SDL2 event handling
- Created `pkg/formats/formats.go` with stub types (GAT, GND, RSW)
- Updated all documentation (ADR-001, CLAUDE.md, README.md, PRD.md)

**Key Features Implemented:**
- SDL2 initialization via go-sdl2 (requires CGO + system SDL2)
- OpenGL 4.1 Core Profile context creation
- Basic shader program (vertex + fragment)
- Triangle with vertex colors (RGB gradient)
- Window resize handling
- ESC key to quit
- FPS logging

## Architecture Explanation (For Boris)

### Game Loop
```
main()
  → game.New()           # Creates window + renderer
    → window.New()       # SDL2 + OpenGL context
    → renderer.New()     # Initializes OpenGL, creates shaders
  → game.Run()           # Main loop
    → input.Update()     # Poll SDL events
    → game.update(dt)    # Update game logic (empty for now)
    → game.render()      # Draw frame
      → renderer.Begin() # Clear screen
      → renderer.DrawTriangle()
      → renderer.End()
    → window.SwapBuffers() # Show frame
```

### OpenGL Concepts Introduced

1. **Shaders**: Programs that run on GPU
   - Vertex shader: Positions vertices
   - Fragment shader: Colors pixels

2. **VAO (Vertex Array Object)**: Stores vertex attribute configuration
3. **VBO (Vertex Buffer Object)**: Stores actual vertex data

4. **Rendering Pipeline**:
   ```
   Vertex Data → Vertex Shader → Rasterization → Fragment Shader → Screen
   ```

## How to Run

```bash
cd /Users/borisglebov/git/Faultbox/midgard-ro

# Install SDL2 (required for go-sdl2)
brew install sdl2  # macOS
# apt install libsdl2-dev  # Linux

# Download dependencies
go mod tidy

# Run the client
go run ./cmd/client
```

**Expected Result:**
- Window opens (1280x720)
- Dark blue-gray background
- RGB triangle in center (red top, green left, blue right)
- Press ESC to close

## Files Modified

| File | Changes |
|------|---------|
| `go.mod` | Changed to go-sdl2, Go 1.22 |
| `cmd/client/main.go` | Updated with milestone info |
| `internal/game/game.go` | Complete rewrite with window/renderer |
| `internal/engine/window/window.go` | SDL2 window management |
| `internal/engine/input/input.go` | SDL2 event handling |
| `internal/engine/renderer/renderer.go` | OpenGL + shaders |
| `pkg/formats/formats.go` | NEW: Stub types for GAT/GND/RSW |
| `docs/adr/ADR-001-graphics-stack.md` | Updated for SDL2 |
| `docs/prd/PRD.md` | Updated for SDL2 |
| `docs/WORKFLOW.md` | NEW: Claude Code workflow guide |
| `docs/research/korangar-and-community.md` | NEW: Research notes |
| `CLAUDE.md` | Updated for SDL2 |
| `README.md` | Updated for SDL2 |

## Why SDL2 over SDL3

- go-sdl3 had version resolution issues (invalid pseudo-versions)
- SDL2 is more mature and stable
- go-sdl2 has better documentation and community support
- The CGO requirement is acceptable for this project

## Next Steps (for next session)

After confirming Milestone 1 works:

1. **Study file formats** (Research Lab docs)
   - Start with GRF archive format
   - Then SPR/ACT for sprites

2. **Milestone 2: Textured Rendering**
   - Load BMP/TGA textures
   - Sprite rendering with transparency
   - Camera system

---

*Session ended: Milestone 1 implemented with SDL2, ready for testing*
