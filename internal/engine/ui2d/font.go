package ui2d

import (
	"unsafe"

	"github.com/go-gl/gl/v4.1-core/gl"
)

// Font holds a bitmap font texture and rendering data.
type Font struct {
	textureID   uint32
	glyphWidth  int
	glyphHeight int
	texWidth    int
	texHeight   int
}

// Classic 8x8 bitmap font data for ASCII characters 32-126
// Each character is 8 bytes (8 rows of 8 bits each)
var font8x8 = []byte{
	// Space (32)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	// ! (33)
	0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x00,
	// " (34)
	0x6C, 0x6C, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00,
	// # (35)
	0x6C, 0x6C, 0xFE, 0x6C, 0xFE, 0x6C, 0x6C, 0x00,
	// $ (36)
	0x18, 0x3E, 0x60, 0x3C, 0x06, 0x7C, 0x18, 0x00,
	// % (37)
	0x00, 0xC6, 0xCC, 0x18, 0x30, 0x66, 0xC6, 0x00,
	// & (38)
	0x38, 0x6C, 0x38, 0x76, 0xDC, 0xCC, 0x76, 0x00,
	// ' (39)
	0x18, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00,
	// ( (40)
	0x0C, 0x18, 0x30, 0x30, 0x30, 0x18, 0x0C, 0x00,
	// ) (41)
	0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x18, 0x30, 0x00,
	// * (42)
	0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00,
	// + (43)
	0x00, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x00, 0x00,
	// , (44)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x30,
	// - (45)
	0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00,
	// . (46)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00,
	// / (47)
	0x06, 0x0C, 0x18, 0x30, 0x60, 0xC0, 0x80, 0x00,
	// 0 (48)
	0x7C, 0xCE, 0xDE, 0xF6, 0xE6, 0xC6, 0x7C, 0x00,
	// 1 (49)
	0x18, 0x38, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00,
	// 2 (50)
	0x7C, 0xC6, 0x06, 0x7C, 0xC0, 0xC0, 0xFE, 0x00,
	// 3 (51)
	0xFC, 0x06, 0x06, 0x3C, 0x06, 0x06, 0xFC, 0x00,
	// 4 (52)
	0x0C, 0xCC, 0xCC, 0xCC, 0xFE, 0x0C, 0x0C, 0x00,
	// 5 (53)
	0xFE, 0xC0, 0xFC, 0x06, 0x06, 0xC6, 0x7C, 0x00,
	// 6 (54)
	0x7C, 0xC0, 0xC0, 0xFC, 0xC6, 0xC6, 0x7C, 0x00,
	// 7 (55)
	0xFE, 0x06, 0x06, 0x0C, 0x18, 0x18, 0x18, 0x00,
	// 8 (56)
	0x7C, 0xC6, 0xC6, 0x7C, 0xC6, 0xC6, 0x7C, 0x00,
	// 9 (57)
	0x7C, 0xC6, 0xC6, 0x7E, 0x06, 0x06, 0x7C, 0x00,
	// : (58)
	0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x00,
	// ; (59)
	0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x30,
	// < (60)
	0x0C, 0x18, 0x30, 0x60, 0x30, 0x18, 0x0C, 0x00,
	// = (61)
	0x00, 0x00, 0x7E, 0x00, 0x7E, 0x00, 0x00, 0x00,
	// > (62)
	0x30, 0x18, 0x0C, 0x06, 0x0C, 0x18, 0x30, 0x00,
	// ? (63)
	0x3C, 0x66, 0x0C, 0x18, 0x18, 0x00, 0x18, 0x00,
	// @ (64)
	0x7C, 0xC6, 0xDE, 0xDE, 0xDE, 0xC0, 0x7E, 0x00,
	// A (65)
	0x38, 0x6C, 0xC6, 0xC6, 0xFE, 0xC6, 0xC6, 0x00,
	// B (66)
	0xFC, 0xC6, 0xC6, 0xFC, 0xC6, 0xC6, 0xFC, 0x00,
	// C (67)
	0x7C, 0xC6, 0xC0, 0xC0, 0xC0, 0xC6, 0x7C, 0x00,
	// D (68)
	0xF8, 0xCC, 0xC6, 0xC6, 0xC6, 0xCC, 0xF8, 0x00,
	// E (69)
	0xFE, 0xC0, 0xC0, 0xF8, 0xC0, 0xC0, 0xFE, 0x00,
	// F (70)
	0xFE, 0xC0, 0xC0, 0xF8, 0xC0, 0xC0, 0xC0, 0x00,
	// G (71)
	0x7C, 0xC6, 0xC0, 0xCE, 0xC6, 0xC6, 0x7C, 0x00,
	// H (72)
	0xC6, 0xC6, 0xC6, 0xFE, 0xC6, 0xC6, 0xC6, 0x00,
	// I (73)
	0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00,
	// J (74)
	0x06, 0x06, 0x06, 0x06, 0xC6, 0xC6, 0x7C, 0x00,
	// K (75)
	0xC6, 0xCC, 0xD8, 0xF0, 0xD8, 0xCC, 0xC6, 0x00,
	// L (76)
	0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFE, 0x00,
	// M (77)
	0xC6, 0xEE, 0xFE, 0xD6, 0xC6, 0xC6, 0xC6, 0x00,
	// N (78)
	0xC6, 0xE6, 0xF6, 0xDE, 0xCE, 0xC6, 0xC6, 0x00,
	// O (79)
	0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00,
	// P (80)
	0xFC, 0xC6, 0xC6, 0xFC, 0xC0, 0xC0, 0xC0, 0x00,
	// Q (81)
	0x7C, 0xC6, 0xC6, 0xC6, 0xD6, 0xDE, 0x7C, 0x06,
	// R (82)
	0xFC, 0xC6, 0xC6, 0xFC, 0xD8, 0xCC, 0xC6, 0x00,
	// S (83)
	0x7C, 0xC6, 0xC0, 0x7C, 0x06, 0xC6, 0x7C, 0x00,
	// T (84)
	0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00,
	// U (85)
	0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00,
	// V (86)
	0xC6, 0xC6, 0xC6, 0xC6, 0x6C, 0x38, 0x10, 0x00,
	// W (87)
	0xC6, 0xC6, 0xC6, 0xD6, 0xFE, 0xEE, 0xC6, 0x00,
	// X (88)
	0xC6, 0xC6, 0x6C, 0x38, 0x6C, 0xC6, 0xC6, 0x00,
	// Y (89)
	0x66, 0x66, 0x66, 0x3C, 0x18, 0x18, 0x18, 0x00,
	// Z (90)
	0xFE, 0x06, 0x0C, 0x18, 0x30, 0x60, 0xFE, 0x00,
	// [ (91)
	0x3C, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3C, 0x00,
	// \ (92)
	0xC0, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x02, 0x00,
	// ] (93)
	0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3C, 0x00,
	// ^ (94)
	0x10, 0x38, 0x6C, 0xC6, 0x00, 0x00, 0x00, 0x00,
	// _ (95)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE,
	// ` (96)
	0x18, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00,
	// a (97)
	0x00, 0x00, 0x7C, 0x06, 0x7E, 0xC6, 0x7E, 0x00,
	// b (98)
	0xC0, 0xC0, 0xFC, 0xC6, 0xC6, 0xC6, 0xFC, 0x00,
	// c (99)
	0x00, 0x00, 0x7C, 0xC6, 0xC0, 0xC6, 0x7C, 0x00,
	// d (100)
	0x06, 0x06, 0x7E, 0xC6, 0xC6, 0xC6, 0x7E, 0x00,
	// e (101)
	0x00, 0x00, 0x7C, 0xC6, 0xFE, 0xC0, 0x7C, 0x00,
	// f (102)
	0x1C, 0x36, 0x30, 0x78, 0x30, 0x30, 0x30, 0x00,
	// g (103)
	0x00, 0x00, 0x7E, 0xC6, 0xC6, 0x7E, 0x06, 0x7C,
	// h (104)
	0xC0, 0xC0, 0xFC, 0xC6, 0xC6, 0xC6, 0xC6, 0x00,
	// i (105)
	0x18, 0x00, 0x38, 0x18, 0x18, 0x18, 0x3C, 0x00,
	// j (106)
	0x06, 0x00, 0x0E, 0x06, 0x06, 0x66, 0x66, 0x3C,
	// k (107)
	0xC0, 0xC0, 0xCC, 0xD8, 0xF0, 0xD8, 0xCC, 0x00,
	// l (108)
	0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00,
	// m (109)
	0x00, 0x00, 0xEC, 0xFE, 0xD6, 0xC6, 0xC6, 0x00,
	// n (110)
	0x00, 0x00, 0xFC, 0xC6, 0xC6, 0xC6, 0xC6, 0x00,
	// o (111)
	0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0x7C, 0x00,
	// p (112)
	0x00, 0x00, 0xFC, 0xC6, 0xC6, 0xFC, 0xC0, 0xC0,
	// q (113)
	0x00, 0x00, 0x7E, 0xC6, 0xC6, 0x7E, 0x06, 0x06,
	// r (114)
	0x00, 0x00, 0xDC, 0xE6, 0xC0, 0xC0, 0xC0, 0x00,
	// s (115)
	0x00, 0x00, 0x7E, 0xC0, 0x7C, 0x06, 0xFC, 0x00,
	// t (116)
	0x30, 0x30, 0x7C, 0x30, 0x30, 0x36, 0x1C, 0x00,
	// u (117)
	0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0x7E, 0x00,
	// v (118)
	0x00, 0x00, 0xC6, 0xC6, 0xC6, 0x6C, 0x38, 0x00,
	// w (119)
	0x00, 0x00, 0xC6, 0xC6, 0xD6, 0xFE, 0x6C, 0x00,
	// x (120)
	0x00, 0x00, 0xC6, 0x6C, 0x38, 0x6C, 0xC6, 0x00,
	// y (121)
	0x00, 0x00, 0xC6, 0xC6, 0xC6, 0x7E, 0x06, 0x7C,
	// z (122)
	0x00, 0x00, 0xFE, 0x0C, 0x38, 0x60, 0xFE, 0x00,
	// { (123)
	0x0E, 0x18, 0x18, 0x70, 0x18, 0x18, 0x0E, 0x00,
	// | (124)
	0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18, 0x00,
	// } (125)
	0x70, 0x18, 0x18, 0x0E, 0x18, 0x18, 0x70, 0x00,
	// ~ (126)
	0x76, 0xDC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
}

// NewFont creates a new bitmap font from the built-in 8x8 font data.
func NewFont() *Font {
	f := &Font{
		glyphWidth:  8,
		glyphHeight: 8,
	}

	// Create a texture atlas with all glyphs arranged horizontally
	// Characters 32-126 = 95 characters
	numChars := 95
	f.texWidth = numChars * f.glyphWidth
	f.texHeight = f.glyphHeight

	// Create RGBA texture data
	texData := make([]byte, f.texWidth*f.texHeight*4)

	for charIdx := 0; charIdx < numChars; charIdx++ {
		charOffset := charIdx * 8 // 8 bytes per character
		texX := charIdx * f.glyphWidth

		for row := 0; row < 8; row++ {
			if charOffset+row >= len(font8x8) {
				break
			}
			rowData := font8x8[charOffset+row]

			for col := 0; col < 8; col++ {
				// Check if bit is set (MSB first)
				bit := (rowData >> (7 - col)) & 1

				// Calculate texture position
				px := texX + col
				py := row
				idx := (py*f.texWidth + px) * 4

				if bit == 1 {
					texData[idx+0] = 255 // R
					texData[idx+1] = 255 // G
					texData[idx+2] = 255 // B
					texData[idx+3] = 255 // A
				} else {
					texData[idx+0] = 0
					texData[idx+1] = 0
					texData[idx+2] = 0
					texData[idx+3] = 0
				}
			}
		}
	}

	// Create OpenGL texture
	gl.GenTextures(1, &f.textureID)
	gl.BindTexture(gl.TEXTURE_2D, f.textureID)
	gl.TexParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST)
	gl.TexParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST)
	gl.TexParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE)
	gl.TexParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE)
	gl.TexImage2D(gl.TEXTURE_2D, 0, gl.RGBA, int32(f.texWidth), int32(f.texHeight), 0,
		gl.RGBA, gl.UNSIGNED_BYTE, unsafe.Pointer(&texData[0]))
	gl.BindTexture(gl.TEXTURE_2D, 0)

	return f
}

// Close releases font resources.
func (f *Font) Close() {
	if f.textureID != 0 {
		gl.DeleteTextures(1, &f.textureID)
		f.textureID = 0
	}
}

// GlyphSize returns the size of a single glyph.
func (f *Font) GlyphSize() (int, int) {
	return f.glyphWidth, f.glyphHeight
}

// TextureID returns the OpenGL texture ID.
func (f *Font) TextureID() uint32 {
	return f.textureID
}

// GetGlyphUV returns the UV coordinates for a character.
// Returns (u0, v0, u1, v1) for the character's texture region.
func (f *Font) GetGlyphUV(char rune) (float32, float32, float32, float32) {
	// Map character to glyph index (32-126)
	idx := int(char) - 32
	if idx < 0 || idx >= 95 {
		idx = 0 // Use space for invalid characters
	}

	// Calculate UV coordinates
	u0 := float32(idx*f.glyphWidth) / float32(f.texWidth)
	u1 := float32((idx+1)*f.glyphWidth) / float32(f.texWidth)
	v0 := float32(0)
	v1 := float32(1)

	return u0, v0, u1, v1
}

// MeasureText returns the width and height of rendered text.
func (f *Font) MeasureText(text string, scale float32) (float32, float32) {
	width := float32(len(text)) * float32(f.glyphWidth) * scale
	height := float32(f.glyphHeight) * scale
	return width, height
}
